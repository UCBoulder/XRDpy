# XRDpy

Process XRD TIFF files from Dectris Eiger R 1M detector (this can easily be extended to other detectors in the source code). This software is designed to stitch raw images together that are generated by CU Boulder Physic's XRD system.

# Installation

It is recommended to create a unique Anaconda environment for the installation because the install will generate globally callable commands from the terminal, and it is nice to isolate these within an Anaconda environment. This guide assumes you will call the environment "XRD", but you can choose any name you wish.

There are two options to install: from PyPI (with pip) or from source.

## Dependencies

XRDpy depends on several other packages. All methods of installation below will automatically install the required dependencies in your conda environment. These are:

- numpy
- matplotlib
- pyFAI
- pyyaml
- fabio
- pathlib
- pyside6
- pyopencl

## Setting up Conda Environment

In Windows, open an Anaconda prompt and run

`conda create --new XRD`

`conda activate XRD`

## Install from source

To install from source code, clone the repository and `cd` into the repository and run (make sure you have the conda environment activated)

`pip install .`

or

`python setup.py install`

## Install from PyPI

With the conda environment activated

`pip install XRDpy`

# Included CLI and GUI programs

## pyFAI-calib2

This is included from pyFAI. Run `pyFAI-calib2` as a first step to generate a PONI file and call it "cal.poni" to place in the directory with the raw data. Using the auto-stitched TIFF file from a AgBh exposure is preferred.

PONI refers to *point of normal incidence* and is the point on the detector that intersects the shortest line between the sample and the detector. In the orientation where the incident beam is normal to the detector and the sample is brought into the beam path, the PONI is the same as the beam center on the detector.

### Calibration procedure

- In the toolbar, select "Y" icon and select "Orient Y-axis downward"
- In the right panel:
    - Set wavelength to 1.54185 Angstrom
    - Select AgBh from calibrants
    - Select the ... button under "Detector" and then "Manual definition"
        - Pixel size: 75 by 75 micron
        - Detector size: 1102 by 3070 pixels
        - Orientation: 2 TopRight (this means top-left when looking at the detector from the sample)
    - Designate the calibration TIFF
    - Optionally set a mask file if you have one saved (otherwise, you can make one in the next step)
- Press "Next" to get to the mask making step. Once a mask is made, Press "Next to get to the ring selection tool
- Select the first few rings and then "extract more rings"
- Select "Next" to begin fitting. Select the "SAXS constraints" and then fit.
- Save the PONI file as "cal.poni" with your data.

The PONI file contains all the relevant parameters (except the exposure time, incident angle, and the detector tilt angle).

## `XRD-stitch`

This will stitch all the raw files in the current working directory. It won't adjust the intensity of pixels with different exposure times; instead it will output two TIFF files:

- *raw-stitched-data.tif*: The stitched data without adjustment of different pixel's exposure times.
- *stitched-exposure-time.tif*: A TIFF where each pixel's intensity represents the exposure time (in seconds) that that pixel in the data set had due to the stitching. This can be used to adjust the intensity of the data in *raw-stitched-data.tif* while keeping track of weights.

Running `XRD-stitch` is optional because other commands that rely on it will automatically perform the stitch if *raw-stitched-data.tif* and *stitch-exposure-time.tif* are not found. The first time a data set is stitched, an exposure time is required to be given with a flag. Once an exposure time is given, it will be saved in *params.yaml* and won't need to be given again.

### Arguments

- Exposure time (in seconds)
    - This is exposure time given to `eiger-stitch` so it represents the total exposure time of two overlapping images (the exposure time of a single raw image is half of `<time in seconds>`).
    - `<time in seconds>` must be an integer.
    - optional if `"exposure"` is defined in *params.yaml*.
    - eg: `XRD-stitch 1200`.

### Flags
- `--incident <incident angle in degrees>` or `-I`
    - This is the angle of incidence of the beam with the sample; i.e. how many degrees the sample is tipped wrt to the beam.
    - Optional to give to XRD-stitch, and can be defined later. This will also get saved in *params.yaml*
    - eg: `XRD-stitch 1200 --incident 0.2`
- `--tilt <detector tilt angle in degrees>` or `-T`
    - This is fully optional.
    - This will rotate the detector clockwise (positive direction) relative to the sample so that you can align the sample normal to the detector's y-direction if the sample is tilted.
- `--dir "<path to directory where data is>"` or `-D`
    - By default, it will look for the data in the current working directory, but you can specify another location. All the saved files will be saved here as well.

## `XRD-film`

Running this will look for data produced by `XRD-stitch`, and if that isn't found will first stitch the raw data. 

This will transform data taken on aligned thin films (e.g. GIWAXS). An incident angle must be defined for the transform to work. This works for grazing incidence as well as non-grazing incidence.

If `"incident"` isn't already defined in *params.yaml*, it must be provided with a flag. By default, both a cake ($|\mathbf{q}|$ vs $\Omega$) and a reciprocal lattice ($q_z$ vs $q_{xy}$) plot will be made and saved as TIFFs. The plots will have intensity adjusted due to the relative exposure at that location, but the TIFF will save the data unadjusted.

For both the cake and reciprocal lattice plots, two individual TIFF files will be produced (one for the intensity per bin and one for exposure time per bin) as well as yaml file containing the first and last value of each axis as well as the number of bins on that axis.

### Flags

All the flags defined above for `XRD-stitch` apply here as well.

- `--exposure <time in seconds>` or `-E`
    - This is exposure time given to `eiger-stitch` so it represents the total exposure time of two overlapping images (the exposure time of a single raw image is half of `<time in seconds>`).
    - `<time in seconds>` must be an integer.
    - optional if `"exposure"` is defined in *params.yaml*.
    - eg: `XRD-stitch --exposure 1200`.
- `--cake` or `-C`
    - Will only do a cake transform and skip the reciprocal lattice transform.
- `--recipricol` or `-Q`
    - Will only do a reciprocal lattice transform and skip the cake transform.

## `XRD-powder`

This will transform data to reciprocal space and a cake plot assuming the sample is a powder. No incident angle or tilt angle is required; only an exposure time is needed. 

### Flags

This takes all the same flags as `XRD-flm` except will ignore any incident or tilt angle given.

## `XRD-red`

Creates a 1D data reduction of transformed data. This program requires that a cake has been created with either `XRD-flm` or `XRD-pow`. By default, it sums over the full azimuthal (-180 to 180 degrees).

The output is a CSV file with the following formatting:

$\begin{array}{ |c|c|c|c| }
 \hline
 q\ (\text{\AA}^{-1}) & \text{Intensity (unadjusted)} & \text{Intensity (adjusted)} & \text{Exposure time (s)} \\
 \hline
\end{array}$

### Flags

- `--sector-size <in degrees>` or `-S`
    - Define sector to integrate if you don't want -180 to 180. By default, it will take a single sector centered at $\Omega=0$.
- `--sector-num <number of sectors>` or `-N`
    - if a sector size is given, this allows you to define multiple sectors of that size to use. By default, these will be evenly spaced, such that $NS+(N+1)O=360\degree$.
- `--sector-offset <in degrees>` or `-O`
    - change the space between sectors (if $N>1$).
- `--sector-tilt <in degrees>` or `-T`
    - change the center position with which sectors are defined (positive direction moves the sector(s) clockwise).
- `--q-range [<start>,<end>]` or `-Q`
    - set bounds (in inverse angstroms) on how much of reciprocal space to include in the integration.

## `XRD-pol`

Create a pole figure (1D Intensity vs $\Omega$). These can be useful for looking at ring segments of aligned films.

### Arguments

- $q$-center
    - Set the $q$ value of the desired ring segment.
- $q$-width
    - set integration width.
- e.g. `XRD-pol 1.2 .05` will integrate from $q=1.175$ to $q=1.225$

## `XRD-plt`

Open interactive TIFFs of transformed data sets.

### Flags

- `--cake` or `-C`
    - Only plot the cake data
- `--recipricol` or `-Q`
    - Only plot reciprocal space data.